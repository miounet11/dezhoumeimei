---
name: Database Schema Extensions
status: open
created: 2025-08-26T04:02:10Z
updated: 2025-08-26T04:02:10Z
last_sync: 2025-08-26T09:23:19Z
github: https://github.com/anthropics/pokeriq-pro/issues/3
imported: true
---

# Task 001: Database Schema Extensions

## Overview

Extend the existing PostgreSQL database schema to support the dezhoumama learning platform by adding new tables for courses, assessments, user progress tracking, virtual characters, and chat sessions. This task focuses on leveraging the existing PokerIQ Pro database structure while adding the necessary tables for content management and AI-powered learning features.

## Technical Requirements

### Database Schema Extensions

```sql
-- Course content management
CREATE TABLE courses (
    id SERIAL PRIMARY KEY,
    title VARCHAR(255) NOT NULL,
    description TEXT,
    level VARCHAR(50) NOT NULL, -- beginner, intermediate, advanced
    content_path VARCHAR(500), -- JSON/Markdown file path
    video_url VARCHAR(500),
    thumbnail_url VARCHAR(500),
    duration_minutes INTEGER,
    prerequisites INTEGER[], -- array of course IDs
    tags VARCHAR(100)[],
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- Assessment system
CREATE TABLE assessments (
    id SERIAL PRIMARY KEY,
    course_id INTEGER REFERENCES courses(id) ON DELETE CASCADE,
    title VARCHAR(255) NOT NULL,
    description TEXT,
    questions JSONB NOT NULL, -- structured quiz questions
    scoring_config JSONB NOT NULL, -- scoring rules and weights
    difficulty VARCHAR(50) NOT NULL,
    pass_threshold INTEGER DEFAULT 70, -- percentage
    time_limit_minutes INTEGER,
    max_attempts INTEGER DEFAULT 3,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- User learning progress
CREATE TABLE user_progress (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL, -- references existing users table
    course_id INTEGER REFERENCES courses(id) ON DELETE CASCADE,
    completion_rate DECIMAL(5,2) DEFAULT 0.00, -- percentage
    current_section INTEGER DEFAULT 1,
    test_scores JSONB DEFAULT '[]', -- array of assessment results
    study_time_minutes INTEGER DEFAULT 0,
    last_accessed TIMESTAMP DEFAULT NOW(),
    completed_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(user_id, course_id)
);

-- Virtual characters for AI conversations
CREATE TABLE characters (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    display_name VARCHAR(100) NOT NULL,
    personality_config JSONB NOT NULL, -- AI personality parameters
    avatar_url VARCHAR(500),
    specialization VARCHAR(100) NOT NULL, -- tournament, cash, theory, etc.
    description TEXT,
    backstory TEXT,
    skill_level VARCHAR(50) NOT NULL, -- beginner, intermediate, expert
    conversation_style VARCHAR(50) NOT NULL, -- friendly, analytical, competitive
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- Chat session management
CREATE TABLE chat_sessions (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL, -- references existing users table
    character_id INTEGER REFERENCES characters(id) ON DELETE CASCADE,
    session_name VARCHAR(255),
    conversation_history JSONB DEFAULT '[]', -- array of message objects
    context_data JSONB DEFAULT '{}', -- session context and metadata
    is_active BOOLEAN DEFAULT true,
    started_at TIMESTAMP DEFAULT NOW(),
    last_message_at TIMESTAMP DEFAULT NOW(),
    ended_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- Indexes for performance
CREATE INDEX idx_courses_level ON courses(level);
CREATE INDEX idx_courses_tags ON courses USING GIN(tags);
CREATE INDEX idx_courses_active ON courses(is_active) WHERE is_active = true;

CREATE INDEX idx_assessments_course_id ON assessments(course_id);
CREATE INDEX idx_assessments_difficulty ON assessments(difficulty);

CREATE INDEX idx_user_progress_user_id ON user_progress(user_id);
CREATE INDEX idx_user_progress_course_id ON user_progress(course_id);
CREATE INDEX idx_user_progress_completion ON user_progress(completion_rate);

CREATE INDEX idx_characters_specialization ON characters(specialization);
CREATE INDEX idx_characters_skill_level ON characters(skill_level);
CREATE INDEX idx_characters_active ON characters(is_active) WHERE is_active = true;

CREATE INDEX idx_chat_sessions_user_id ON chat_sessions(user_id);
CREATE INDEX idx_chat_sessions_character_id ON chat_sessions(character_id);
CREATE INDEX idx_chat_sessions_active ON chat_sessions(is_active) WHERE is_active = true;
CREATE INDEX idx_chat_sessions_last_message ON chat_sessions(last_message_at DESC);
```

### Migration Strategy

1. **Backup existing database** before applying schema changes
2. **Create migration scripts** with rollback capability
3. **Test migrations** on development environment first
4. **Apply schema changes** in production during low-traffic window
5. **Verify data integrity** post-migration

### Data Validation Rules

- Course titles must be unique within the same level
- Assessment questions must follow structured JSON schema
- User progress completion rates must be between 0-100
- Character personality configs must contain required AI parameters
- Chat session history must maintain message ordering

## Acceptance Criteria

- [ ] All new database tables created successfully
- [ ] Proper foreign key relationships established
- [ ] Performance indexes created and optimized
- [ ] Migration scripts with rollback capability written
- [ ] Data validation constraints implemented
- [ ] Integration with existing user authentication system verified
- [ ] Database performance benchmarks met (P95 < 100ms for queries)
- [ ] Schema documentation updated

## Implementation Details

### Files to Modify/Create

- `database/migrations/xxx_add_dezhoumama_tables.sql`
- `database/seeds/xxx_initial_characters.sql` 
- `src/lib/db/schema.ts` - TypeScript type definitions
- `src/lib/db/queries/courses.ts` - Course query functions
- `src/lib/db/queries/assessments.ts` - Assessment query functions
- `src/lib/db/queries/progress.ts` - Progress tracking queries
- `src/lib/db/queries/characters.ts` - Character management queries
- `src/lib/db/queries/chat.ts` - Chat session queries

### Testing Requirements

- Unit tests for all database query functions
- Integration tests for complex queries with joins
- Performance tests for concurrent user scenarios
- Migration rollback testing
- Data integrity validation tests

## Effort Estimation

- **Size**: Medium (M)
- **Estimated Hours**: 20-25 hours
- **Sprint Points**: 8

## Dependencies

- Access to existing PostgreSQL database schema
- Understanding of current user authentication system
- Coordination with backend API development for query integration

## Technical Risks

- **Schema conflicts** with existing tables
- **Performance impact** on existing queries
- **Migration downtime** during production deployment
- **Data integrity** issues during schema changes

## Definition of Done

- All database tables created and properly indexed
- Migration scripts tested and documented
- TypeScript types generated for new schema
- Query functions implemented and tested
- Performance benchmarks validated
- Code review completed and approved
- Documentation updated with schema changes